define(["jquery","wdn","require","idm","notice","./vendor/jsrender.js"],function(a,b,c,d){"use strict";var e,f,g,h,i,j,k,l,m,n="https://directory.unl.edu/",o="https://annotate.unl.edu/",p="",q=a("<progress>",{class:"loading"}).text("Loading..."),r=1,s=["searching","single","single-dept"],t=[],u=[],v=!1,w="",x={initialize:function(){var b=a(".filters",i),c=x.clear(),d=a(".results",h),e=a(".summary",h),f=a(".ppl_Sresult",h);if(!d.length||!f.length)return void i.closest(".results-container").addClass("empty-filters");b.addClass("loading"),i.closest(".results-container").removeClass("empty-filters"),a(".results",h).each(function(){a(this).hasClass("departments")||(a(".organization-unit",this).each(function(){var b=a(this).text().trim(),c=x.scrubDept(b.toLowerCase());a.inArray(b,t)<0&&t.push(b),a(this).parents(".ppl_Sresult").addClass(c)}),u.push(a(this).children("h2").eq(0).text()))}),t.sort(),u.sort(),x.buildFilters(t,"department"),x.buildFilters(u,"affiliation"),a(window).width()>=768?(c.slideDown(100),c.attr("aria-expanded","true"),a(".toggle",i).text("(Collapse)")):(c.slideUp(100),c.attr("aria-expanded","false"),a(".toggle",i).text("(Expand)")),b.removeClass("loading"),e.length||(e=a(a.templates("#summaryTemplate").render()).append(x.generateAllSummaryOption()).prependTo(h)),t=[],u=[],i.removeClass("few-results"),i.removeClass("many-results"),f.length<=10?i.addClass("few-results"):i.addClass("many-results"),a(".skipnav a",i).on("click",function(){return a("#results").focus(),!1})},clear:function(){return a(".filter-options",i).empty()},generateAllSummaryOption:function(){var b=a.templates("#summaryAllTemplate");return a(b.render())},buildFilters:function(b,c){var d=a("#filters_"+c),e=a("ol",d),f=a.templates("#filterOptionTemplate"),g=[];e.length||(e=a(a.templates("#filterOptionListTempalte").render({type:c})).appendTo(d)),a.each(b,function(b,c){g.push(a(f.render({type:x.scrubDept(c.toLowerCase()),label:c})))}),e.append(g)},action:function(b){var c=[],d=".result_head, div.affiliation, div.results ul li",e=b.closest(".filter-options"),f=b[0].checked,g=function(){var b=a("input:checked",i).not(".filterAll");if(!b.length)return void a(d,h).show();a(d,h).hide(),b.each(function(){var b=a(this).attr("value"),d=a(this).attr("id");this.checked&&(a("li."+b,h).show().closest(".affiliation").show(),c.push(d))})},j=function(b){var c=e;b&&(c=i),a("input",c).not(".filterAll").prop("checked",!1),a(".filterAll",c).prop("checked",!0),g()};b.hasClass("filterAll")&&f||!a("input:checked",e).length?j():(a(".filterAll",e).prop("checked",!1),g());var k=a(".summary",h);if(a(".selected-options, .operator",k).remove(),c.length<1)j(!0),k.append(x.generateAllSummaryOption());else{var l=[],m=a.templates("#summaryFilterTemplate");a.each(c,function(b,c){var d=a("#"+c);if(d.length){var e=d.closest(".filter-options").prev("button"),f={filterType:e.clone().children().remove().end().text(),filterValue:d.attr("value"),filterLabel:d.siblings("label").text()};l.push(document.createTextNode(" ")),l.push(m.render(f)),l.push(document.createTextNode(" "))}}),k.append(l),a(".operator:last-child",k).remove()}y()},scrubDept:function(a){return a.split(" ").join("").replace(/&|,/gi,"")}},y=function(){var b=a(".summary",h);a(".num-results",b).remove();var c=a("div.results ul li:visible").length;c+=1===c?" result":" results",b.append(a("<span>",{class:"num-results"}).text(" - "+c))},z=function(b){k=b,void 0!==b&&(b=s[b]);var c=a("#dcf-main");c.removeClass(s.join(" ")),b&&c.addClass(b)},A=function(b){a(".record-single").empty().append(b)},B=function(b,c){var d=a.templates("#annotateTemplate"),e={view:"annotation",sitekey:"directory",fieldname:b},f=o+"?"+a.param(e);a(d.render({annotateUrl:f,preferredName:c.data("preferred-name")})).appendTo(a(".vcard-tools.primary",c))},C=function(b,c){var d=a.templates("#correctionButtonTemplate"),e=a(d.render({preferredName:b}));c.hasClass("office")&&c.find(".department-correction").length?c.find(".department-correction").after(e):c.find(".vcard-tools").after(e)},D=function(a,b,c){window.history.pushState&&window.history.pushState({uid:a},b,n+"people/"+a),z(1),A(c)},E=function(b,c){var d;return d="org"===b?c+"/summary?format=partial":n+"hcards-full/"+c,a.ajax({url:d})},F=function(b,c){var d,e=".vcard";a(".error",c).remove(),"org"===b&&(e=".departmentInfo");var f=c.children(e),g=c.children(".overflow");if(c.hasClass("selected"))return console.log("li selected"),g.slideDown(),f.slideUp(),c.removeClass("selected"),void a("a:first",g).addClass("programmatically-focused").focus();if(a("li.current",h).removeClass("current"),c.addClass("selected current"),f.length)return console.log("alreaded loaded"),g.slideUp(),f.slideDown(),void a("a:first",f).addClass("programmatically-focused").focus();var i;c.children(".loading").length||(i=setTimeout(function(){c.append(q)},250)),d="org"===b?c.data("href"):c.data("uid"),E(b,d).then(function(e,f){if("success"===f){var h=a(e).hide();c.append(h);var j=a("<button>",{class:"close-full-record","aria-label":"close this record"});j.click(function(){return console.log("close button clicked"),F(b,c),!1}),j.text("X"),h.parent().find(".vcard:first").prepend(j),"org"!==b?(B(d,h),C(h.data("preferred-name"),h)):a(".department-correction",h).length&&C(h.data("preferred-name"),h.find(".vcard")),console.log("fetch record sliding"),g.slideUp(),h.slideDown(),a("a:first",h).addClass("programmatically-focused").focus(),clearTimeout(i),c.children(".loading").remove()}},function(){var b=a.templates("#genericErrorTemplate");c.append(b.render()),clearTimeout(i),c.children(".loading").remove()})},G=function(){var b=a(".record-single .vcard");if(b.length){var c=a(".ppl_Sresult.selected").filter(function(){return!a(".vcard",this).length&&a(this).data("uid")==b.data("uid")});c.length&&c.append(b)}},H=function(b){b.on("click",".ppl_Sresult",function(b){var c=a(b.target),d=c.closest("a"),e=d.closest(".fn");if(!d.length||e.length)return c.closest(".correction").length?void X(c):(F("person",a(this)),!1)}),b.on("keydown",".ppl_Sresult",function(b){this===b.target&&13===b.which&&F("person",a(this))})},I=function(b){b.on("click",".dep_result",function(b){var c=a(b.target),d=c.closest("a"),e=d.closest(".fn");if(!d.length||e.length)return c.closest(".correction").length?void X(c):(F("org",a(this)),!1)}),b.on("keydown",".dep_result",function(b){this===b.target&&13===b.which&&F("org",a(this))})},J=function(c){c.on("click",".dir-btn-print-vcard",function(b){if(1===k)return void window.print();var c=a(this).closest(".vcard");if(!c.length)return!1;var d=c.data("uid"),e=c.data("preferred-name");D(d,e,c),window.print(),b.preventDefault()}),c.on("click",".dir-btn-qr-code-vcard",function(){var c=a(this),d=function(){v=!0,a(c).colorbox({open:!0,photo:!0})};return v?d():b.initializePlugin("modal",[d]),!1}),c.on("click",".wdn_annotate",function(b){var c=a(this);b.preventDefault(),c.qtip({overwrite:!1,content:{text:a("<iframe>",{src:this.href,scrolling:"no",class:"wdn_annotate_note",title:"Your notes"})},position:{my:"top right",at:"bottom right"},show:{event:b.type,ready:!0},hide:"unfocus"},b)})},K=function(a){return a&&a.match(/^q\//)},L=function(){return window.location.hash.replace("#","").trim()},M=function(){g=a("#peoplefinder"),h=a("#results"),i=a("#filters"),g.submit(function(b){a("#search-notice").slideUp(function(){a(this).empty()});var c=a("#q").val().trim();if(c.length){var d="#q/"+encodeURIComponent(c);window.location.hash=d,p=c}h.focus(),b.preventDefault()}),J(h.add(".record-container")),H(h),I(h),i.on("click","button",function(b){var c=a(this),d=c.next(),e=a(".toggle",c);d.slideToggle(100,function(){d.is(":visible")?(e.text("(Collapse)"),d.attr("aria-expanded","true"),d.focus()):(e.text("(Expand)"),d.attr("aria-expanded","false"))})}),i.on("click","input",function(b){x.action(a(this))})},N=function(b){a(".help-container").length?z(b):a.ajax({url:n,data:{format:"partial"},success:function(c){z(b),a("#dcf-main").empty().html(c),M(),L()&&a(window).trigger("hashchange")},error:function(){a("#dcf-main").prepend("<p>Something went wrong. Please try again later.</p>")}})},O=null,P=null,Q=function(b,c,d){var e,f=a(".modal-content",l),g=a(c,b);m?m.detach():m=a("<button>",{class:"cancel dcf-absolute dcf-pin-top dcf-pin-right dcf-mt-1 dcf-mr-1 dcf-btn dcf-btn-tertiary"}).click(function(){R()}).append(a("<span>",{class:"wdn-icon-cancel","aria-hidden":"true"})).append(a("<span>",{class:"dcf-sr-only"}).text("Close")),e=f.children(),m.appendTo(f),O&&e.length&&O.append(e),O=b,P=a(d),g.appendTo(f),a("html").css("overflow","hidden"),l.attr("aria-expanded","true"),l.addClass("show"),setTimeout(function(){f.focus()},400)},R=function(){var b,c=a(".modal-content",l);l.hasClass("show")&&(m&&m.detach(),b=c.children(),O&&(O.append(b),O=null),a("html").css("overflow",""),l.attr("aria-expanded","false"),l.removeClass("show"),P&&(P.focus(),P=null))},S=function(d){b.initializePlugin("jqueryui",[function(){c(["./vendor/jquery.ui.touch-punch.js","./vendor/jquery.mjs.nestedSortable.js"],function(){var b=d.closest("#listings").find("form.sortform");d.nestedSortable({revert:!1,scroll:!0,delay:100,opacity:.45,tolerance:"pointer",helper:"clone",update:function(c,e){var f=JSON.stringify(d.nestedSortable("toHierarchy"));a('[name="sort_json"]',b).val(f),b.submit()},items:"li.listing",handle:".listingDetails",forcePlaceholderSize:!0,placeholder:"ui-placeholder",toleranceElement:".listingDetails"})})}]),d.on("click",".edit-button",function(b){var c=this,d=a(this).closest(".tools"),e=a(".form",d);return a(".forms",d).removeClass("show-add"),a(".edit",e).length?Q(d,".forms",c):e.load(this.href+"?"+a.param({format:"partial"}),function(){Q(d,".forms",c)}),!1})},T=function(b,c,d,e,f){a.post(b.action+"?"+a.param({redirect:"0"}),a(b).serialize(),function(){var g=a(e.render(f)).hide(),h=a("."+d,c);h.length||(h=a("<ul>",{class:d}).insertBefore(b)),h.append(g),g.fadeIn(function(){a(document.body).trigger("sticky_kit:recalc")}),b.reset()}).fail(function(){alert("Your request failed. Please check your input and try again.")}).always(function(){b.reset()})},U=function(b){var c=a(b);a.post(b.action+"?"+a.param({redirect:"0"}),c.serialize(),function(){c.closest("li").slideUp(function(){var b=a(this).closest(".ui-sortable");a(this).remove(),a(document.body).trigger("sticky_kit:recalc"),b.length&&b.nestedSortable("refresh")})})},V=function(b){var c=a(b),d={redirect:"0",render:"summary",format:"partial"};a.post(b.action+"?"+a.param(d),c.serialize(),function(b){c.closest(".department-summary").find(".departmentInfo").replaceWith(b),a(document.body).trigger("sticky_kit:recalc"),a("#dcf-main").focus()})},W=function(b,c){var d=a(b),e={redirect:c||"0",render:"listing",format:"partial"};a.post(b.action+"?"+a.param(e),d.serialize(),function(b){var c=d.closest(".listing"),e=a("#listings"),f=a(".editing > ol.listings",e);c.length?(c.replaceWith(b),c.closest(".ui-sortable").nestedSortable("refresh")):(c=a(b),f.length?(c.hide().appendTo(f).fadeIn(),c.closest(".ui-sortable").nestedSortable("refresh")):(f=a("<ol>",{class:"listings"}).insertBefore(d.closest(".edit-tools")),c.appendTo(f),S(f)))})},X=function(b){var c=b.closest(".vcard"),e=a(".corrections-template"),f=a("form",e),g=d.getDisplayName()||"",h=d.getEmailAddress()||"";f[0].reset(),g&&a('input[name="name"]',f).val(g),h&&a('input[name="email"]',f).val(h),a('input[name="source"]',f).val(a(".permalink",c).attr("href")),c.hasClass("office")?(a('input[name="kind"]',f).val("office"),a('input[name="id"]',f).val(c.data("listing-id"))):(a('input[name="kind"]',f).val("person"),a('input[name="id"]',f).val(c.data("uid"))),f.removeClass("hidden"),e.find(".success").addClass("hidden"),Q(e,".correction-form",b)},Y={queuePFRequest:function(b,c,d,g,h){var i={format:"partial"};d&&(i.chooser="true");var j=b,k=!1;g||h?(k=!0,j=g+" "+h,i.cn=g,i.sn=h):i.q=b,clearTimeout(e),f&&f.abort();var l=a.templates("#queryLengthTemplate"),m=a("#"+c);j.length>3?(x.clear(),m.empty().append(q),e=setTimeout(function(){f=a.ajax({url:n,data:i,success:function(b,c){if("success"===c){var d,e=function(b,c){window.location.hash="q/"+b+"/"+c;var d=a.templates("#noticeTemplate"),e={originalSearch:p,firstName:b,lastName:c};a("#search-notice").html(d.render(e)),r++};if(b.indexOf("Sorry, no results could be found.")>=0&&p&&r<3){if(!k&&p.indexOf(" ")>0)return d=p.split(" ",2),void e(d[0],d[1].substring(0,1));if(k)return void(2===r?(d=p.split(" ",2),e(d[0].substring(0,1),d[1])):(d=p.split(" ",2),e(d[0],d[1].substring(0,1))))}m.html(b),a("ul.pfResult li",m).each(function(){a(".fn a",this).removeAttr("onclick")}),a("#search-notice").slideDown(400),r=1,x.initialize(),y()}},error:function(b,c){if("abort"!==c){var d=a.templates("#genericErrorTemplate");m.html(d.render())}}})},400)):j?m.html(l.render()):(m.empty(),z())},pfCatchUID:function(a){return console.log("I caught "+a+". You should create your own pfCatchUID function."),!1},initialize:function(c,d){Y.initialize=a.noop,n=c,o=d;w=" | "+document.title.split(" | ").slice(-2).join(" | "),a(function(){if(b.initializePlugin("notice"),a("#main-entry").remove(),a("#annotateTemplate").appendTo("body"),a(window).on("hashchange",function(b){var c=L();if(!c||K(c)){if(!c)return void(0===k&&z());c=c.split("/");var d,e,f,g=!1,h=a("#q");return c.length>=3?(g=!0,f=decodeURIComponent(c[1]),e=decodeURIComponent(c[2]),d=f+" "+e):d=decodeURIComponent(c[1]),h.val(d),z(0),g?Y.queuePFRequest("","results","",f,e):Y.queuePFRequest(d,"results"),document.title="Search for "+d+w,!1}}),a(window).on("popstate",function(b){var c=b.originalEvent;if(c.state)c.state.uid?E("person",c.state.uid).then(function(b,d){if("success"===d){var e=a(b);B(c.state.uid,e),C(e.data("preferred-name"),e),z(1),A(e)}},function(){z(0);var b=a.templates("#genericErrorTemplate");h.empty().append(b.render())}):z();else if(2===j)G(),z(j);else{var d=L();if(d&&K(d))return G(),void N(0);if(0!==k)return;N()}}),L()&&a(window).trigger("hashchange"),a(document).on("click","a.dir-btn-print-vcard",function(a){setTimeout(window.print,10),a.preventDefault()}),l=a("#modal_edit_form"),a(document).on("focusin",function(b){var c=l.get(0);l.hasClass("show")&&!a.contains(c,b.target)&&c!=b.target&&(b.stopPropagation(),l.focus())}),l.on("keydown",function(a){27===a.which&&R()}).on("submit","form.edit",function(b){var c=a(this).closest(".forms");b.preventDefault(),R(),c.data("department-id")?V(this):c.data("listing-id")?W(this):W(this,"2")}).on("submit","form.delete",function(b){var c=a(this).closest(".forms");b.preventDefault(),R(),c.data("department-id")||U(this)}),a("#peoplefinder").length)M();else if(a(".record-container .department-summary").length){var d=a(".record-container .department-summary"),e=a("#editBox"),f=a("#all_employees"),g=a("#listings"),i=a(".editing > ol.listings",g),m="Are you sure? This will permanently delete this department and all its children.";if(j=2,z(j),H(f),J(f),d.on("click",".vcard-tools .dir-btn-suggest-correction",function(a){return Q(e,".forms",this),!1}).on("click",".vcard-tools .dir-btn-delete",function(a){if(!confirm(m))return!1}).on("click",".aliases .dir-btn-delete",function(){if(!confirm("Are you sure? This will delete the alias."))return!1}).on("submit",".aliases form.add",function(b){var c=a.templates("#deparmentAliasTemplate"),d=a('[name="name"]',this),f={url:this.action,name:d.val(),department:e.data("department-id")};b.preventDefault(),T(this,b.delegateTarget,"dept_aliases",c,f)}).on("submit",".aliases form.delete",function(a){a.preventDefault(),U(this)}).on("click",".users .dir-btn-delete",function(){if(!confirm("Are you sure? This will remove editing access for this user."))return!1}).on("submit",".users form.add",function(b){var d=a.templates("#departmentUserTemplate"),f=a('[name="uid"]',this),g={url:this.action,userUrl:c+"people/"+f.val(),uid:f.val(),department:e.data("department-id")};b.preventDefault(),T(this,b.delegateTarget,"dept_users",d,g)}).on("submit",".users form.delete",function(a){a.preventDefault(),U(this)}),i.length&&S(i),g.on("click",".listing-add",function(b){var c=this,d=a(this).closest(".edit-tools"),e=a(".form",d);return a(".edit",e).length?Q(d,".forms",c):e.load(this.href+"?"+a.param({format:"partial"}),function(){Q(d,".forms",c)}),!1}).on("submit","form.sortform",function(b){b.preventDefault(),a.post(this.action+"?"+a.param({redirect:0}),a(this).serialize())}),l.on("click.listings",".dir-btn-delete",function(a){if(!confirm(m))return!1}).on("click.listings",".listing-add",function(b){var c=a(this).closest(".forms");return a(".add-form",c).load(this.href+"?"+a.param({format:"partial"}),function(){c.addClass("show-add"),a("input:visible",this).first().focus()}),!1}),a(".department-correction").length){var n=d.find(".vcard");C(n.data("preferred-name"),n)}}else if(a(".record-container .vcard").length){j=1,z(j);var n=a(".record-container .vcard");B(n.data("uid"),n),C(n.data("preferred-name"),n),J(a(".record-container"));var o=a(".record-container .directory-knowledge-summary");o.length}a("button.correction").click(function(b){X(a(b.target))}),a(".corrections-template form").on("submit",function(b){b.preventDefault();var c=a(this).closest(".correction-form");c.find("form").addClass("hidden");var d=c.find(".success");d.text("Submitting...").removeClass("hidden").focus(),a.post(this.action+"?"+a.param({format:"json"}),a(this).serialize()).done(function(){d.text("Thank you for your correction.").focus()}).fail(function(){d.text("There was an error submitting the correction, please try again later.").focus()})}),a("body").on("focusout",function(b){var c=a(b.target);c.hasClass("programmatically-focused")&&c.removeClass("programmatically-focused")})})}};return Y});
//# sourceMappingURL=directory.min.js.map