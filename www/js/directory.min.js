define(["jquery","wdn","require","idm","notice","./vendor/jsrender.js","./vendor/jquery.qtip.js"],function(p,l,e,o){"use strict";var c,d,t,m,h,u,f,g,v="https://directory.unl.edu/",r="https://annotate.unl.edu/",y="",b=p("<progress>",{class:"loading"}).text("Loading..."),w=1,C="#genericErrorTemplate",k="#dcf-main",T="#annotateTemplate",n=["searching","single","single-dept"],a=[],s=[],i=!1,x=".results-container",q="empty-filters";p.views.settings.allowCode(!0);function S(e){void 0!==(f=e)&&(e=n[e]);var t=p(k);t.removeClass(n.join(" ")),e&&t.addClass(e)}function D(e){p(".record-single").empty().append(e)}function _(e,t){var n=p.templates(T),e=r+"?"+p.param({view:"annotation",sitekey:"directory",fieldname:e});p(n.render({annotateUrl:e,preferredName:t.data("preferred-name")})).appendTo(p(".vcard-tools.primary",t))}function j(e,t){var n=p.templates("#correctionButtonTemplate"),e=p(n.render({preferredName:e}));(t.hasClass("office")&&t.find(".department-correction").length?t.find(".department-correction"):t.find(".vcard-tools")).after(e)}function z(e,t){return t="org"===e?t+"/summary?format=partial":v+"hcards-full/"+t,p.ajax({url:t})}function A(){var e,t=p(".record-single .vcard");!t.length||(e=p(".ppl_Sresult.selected").filter(function(){return!p(".vcard",this).length&&p(this).data("uid")==t.data("uid")})).length&&e.append(t)}function U(e){e.on("click",".ppl_Sresult",function(e){var t=p(e.target),n=t.closest("a"),e=n.closest(".fn");if(!n.length||e.length){if(!t.closest(".correction").length)return X("person",p(this)),!1;Z(t)}}),e.on("keydown",".ppl_Sresult",function(e){this===e.target&&13===e.which&&X("person",p(this))})}function I(e){e.on("click",".dir-btn-print-vcard",function(e){if(1!==f){var t=p(this).closest(".vcard");if(!t.length)return!1;var n=t.data("uid"),r=t.data("preferred-name");n=n,r=r,t=t,window.history.pushState&&window.history.pushState({uid:n},r,v+"people/"+n),S(1),D(t),window.print(),e.preventDefault()}else window.print()}),e.on("click",".dir-btn-qr-code-vcard",function(){function e(){i=!0,p(t).colorbox({open:!0,photo:!0})}var t=p(this);return i?e():l.initializePlugin("modal",[e]),!1}),e.on("click",".directory_annotate",function(e){var t=p(this);e.preventDefault(),t.qtip({overwrite:!1,content:{text:p("<iframe>",{src:this.href,scrolling:"no",class:"directory_annotate_note",title:"Your notes"})},position:{my:"top right",at:"bottom right"},show:{event:e.type,ready:!0},hide:"unfocus"},e)})}function P(e){return e&&e.match(/^q\//)}function N(){return window.location.hash.replace("#","").trim()}function O(){var e;t=p("#peoplefinder"),m=p("#results"),h=p("#filters"),t.submit(function(e){p("#search-notice").slideUp(function(){p(this).empty()});var t,n=p("#q").val().trim();n.length&&(t="#q/"+encodeURIComponent(n),window.location.hash=t,y=n),m.focus(),e.preventDefault()}),I(m.add(".record-container")),U(m),(e=m).on("click",".dep_result",function(e){var t=p(e.target),n=t.closest("a"),e=n.closest(".fn");if(!n.length||e.length){if(!t.closest(".correction").length)return X("org",p(this)),!1;Z(t)}}),e.on("keydown",".dep_result",function(e){this===e.target&&13===e.which&&X("org",p(this))}),h.on("click","button",function(e){var t=p(this),n=t.next(),r=p(".toggle",t);n.slideToggle(100,function(){n.is(":visible")?(r.text("(Collapse)"),n.attr("aria-expanded","true"),n.focus()):(r.text("(Expand)"),n.attr("aria-expanded","false"))})}),h.on("click","input",function(e){Y.action(p(this))})}function R(t){p(".help-container").length?S(t):p.ajax({url:v,data:{format:"partial"},success:function(e){S(t),p(k).empty().html(e),O(),N()&&p(window).trigger("hashchange")},error:function(){p(k).prepend("<p>Something went wrong. Please try again later.</p>")}})}function F(e,t,n){var r=p(H,L),i=p(t,e);B?B.detach():B=p("<button>",{class:"cancel dcf-absolute dcf-pin-top dcf-pin-right dcf-mt-1 dcf-mr-1 dcf-btn dcf-btn-tertiary"}).click(function(){G()}).html('<span aria-hidden="true">X</span>').append(p("<span>",{class:"dcf-sr-only"}).text("Close")),t=r.children(),B.appendTo(r),J&&t.length&&J.append(t),J=e,V=p(n),i.appendTo(r),p("html").css("overflow","hidden"),L.attr("aria-expanded","true"),L.addClass("show"),setTimeout(function(){r.focus()},400)}function E(i){l.initializePlugin("jqueryui",[function(){e(["./vendor/jquery.ui.touch-punch.js","./vendor/jquery.mjs.nestedSortable.js"],function(){var r=i.closest("#listings").find("form.sortform");i.nestedSortable({revert:!1,scroll:!0,delay:100,opacity:.45,tolerance:"pointer",helper:"clone",update:function(e,t){var n=JSON.stringify(i.nestedSortable("toHierarchy"));p('[name="sort_json"]',r).val(n),r.submit()},items:"li.listing",handle:".listingDetails",forcePlaceholderSize:!0,placeholder:"ui-placeholder",toleranceElement:".listingDetails"})})}]),i.on("click",".edit-button",function(e){var t=this,n=".forms",r=p(this).closest(".tools"),i=p(".form",r);return p(n,r).removeClass("show-add"),p(".edit",i).length?F(r,n,t):i.load(this.href+"?"+p.param({format:"partial"}),function(){F(r,n,t)}),!1})}var L,B,Y={initialize:function(){var e=p(".filters",h),t=Y.clear(),n=p(".results",m),r=p(".summary",m),i=p(".ppl_Sresult",m);n.length&&i.length?(e.addClass("loading"),h.closest(x).removeClass(q),p(".results",m).each(function(){p(this).hasClass("departments")||(p(".organization-unit",this).each(function(){var e=p(this).text().trim(),t=Y.scrubDept(e.toLowerCase());p.inArray(e,a)<0&&a.push(e),p(this).parents(".ppl_Sresult").addClass(t)}),s.push(p(this).children("h2").eq(0).text()))}),a.sort(),s.sort(),Y.buildFilters(a,"department"),Y.buildFilters(s,"affiliation"),768<=p(window).width()?(t.slideDown(100),t.attr("aria-expanded","true"),p(".toggle",h).text("(Collapse)")):(t.slideUp(100),t.attr("aria-expanded","false"),p(".toggle",h).text("(Expand)")),e.removeClass("loading"),r.length||p(p.templates("#summaryTemplate").render()).append(Y.generateAllSummaryOption()).prependTo(m),a=[],s=[],h.removeClass("few-results"),h.removeClass("many-results"),i.length<=10?h.addClass("few-results"):h.addClass("many-results"),p(".skipnav a",h).on("click",function(){return p("#results").focus(),!1})):h.closest(x).addClass(q)},clear:function(){return p(".filter-options",h).empty()},generateAllSummaryOption:function(){var e=p.templates("#summaryAllTemplate");return p(e.render())},buildFilters:function(e,t){var n=p("#filters_"+t),r=p("ol",n),i=p.templates("#filterOptionTemplate"),a=[];r.length||(r=p(p.templates("#filterOptionListTempalte").render({type:t})).appendTo(n)),p.each(e,function(e,t){a.push(p(i.render({type:Y.scrubDept(t.toLowerCase()),label:t})))}),r.append(a)},action:function(e){function t(){var e=p(o,h).not(l);e.length?(p(i,m).hide(),e.each(function(){var e=p(this).attr("value"),t=p(this).attr("id");this.checked&&(p("li."+e,m).show().closest(".affiliation").show(),r.push(t))})):p(i,m).show()}function n(e){p("input",e=e?h:c).not(l).prop(a,!1),p(l,e).prop(a,!0),t()}var r=[],i=".result_head, div.affiliation, div.results ul li",a="checked",o="input:"+a,s="filterAll",l="."+s,c=e.closest(".filter-options"),d=e[0].checked;e.hasClass(s)&&d||!p(o,c).length?n():(p(l,c).prop(a,!1),t());var u,f,d=p(".summary",m);p(".selected-options, .operator",d).remove(),r.length<1?(n(!0),d.append(Y.generateAllSummaryOption())):(u=[],f=p.templates("#summaryFilterTemplate"),p.each(r,function(e,t){t=p("#"+t);t.length&&(t={filterType:t.closest(".filter-options").prev("button").clone().children().remove().end().text(),filterValue:t.attr("value"),filterLabel:t.siblings("label").text()},u.push(document.createTextNode(" ")),u.push(f.render(t)),u.push(document.createTextNode(" ")))}),d.append(u),p(".operator:last-child",d).remove()),W()},scrubDept:function(e){return e.split(" ").join("").replace(/&|,/gi,"")}},W=function(){var e=p(".summary",m);p(".num-results",e).remove();var t=p("div.results ul li:visible").length;t+=1===t?" result":" results",e.append(p("<span>",{class:"num-results"}).text(" - "+t))},X=function(r,i,e){var a,t=".vcard";p(".error",i).remove();var o,n=i.children(t="org"===r?".departmentInfo":t),s=i.children(".overflow");return i.hasClass("selected")?(console.log("li selected"),void(e&&(n.hide(0,function(){s.show("fast",function(){p(this).addClass("dcf-d-flex")})}),i.removeClass("selected"),p("a:first",s).addClass("programmatically-focused").focus()))):(p("li.current",m).removeClass("current"),i.addClass("selected current"),n.length?(console.log("alreaded loaded"),s.hide(0,function(){p(this).removeClass("dcf-d-flex"),n.show("fast")}),void p("a:first",n).addClass("programmatically-focused").focus()):(i.children(".loading").length||(o=setTimeout(function(){i.append(b)},250)),a="org"===r?i.data("href"):i.data("uid"),void z(r,a).then(function(e,t){var n;"success"===t&&(n=p(e).hide(),i.append(n),(e=p("<button>",{class:"close-full-record dcf-btn dcf-btn-tertiary","aria-label":"close this record"})).click(function(){return console.log("close button clicked"),X(r,i,!0),!1}),e.text("X"),n.parent().find(".vcard:first").prepend(e),"org"!==r?(_(a,n),j(n.data("preferred-name"),n)):p(".department-correction",n).length&&j(n.data("preferred-name"),n.find(".vcard")),console.log("fetch record sliding"),s.hide(0,function(){p(this).removeClass("dcf-d-flex"),n.show("fast")}),p("a:first",n).addClass("programmatically-focused").focus(),clearTimeout(o),i.children(".loading").remove())},function(){var e=p.templates(C);i.append(e.render()),clearTimeout(o),i.children(".loading").remove()})))},H=".modal-content",J=null,V=null,G=function(){var e=p(H,L);L.hasClass("show")&&(B&&B.detach(),e=e.children(),J&&(J.append(e),J=null),p("html").css("overflow",""),L.attr("aria-expanded","false"),L.removeClass("show"),V&&(V.focus(),V=null))};p(".edit-button").removeClass("dcf-d-none");function K(n,r,i,a,o){p.post(n.action+"?"+p.param({redirect:"0"}),p(n).serialize(),function(){var e=p(a.render(o)).hide(),t=p("."+i,r);(t=!t.length?p("<ul>",{class:i}).insertBefore(n):t).append(e),e.fadeIn(function(){p(document.body).trigger("sticky_kit:recalc")}),n.reset()}).fail(function(){alert("Your request failed. Please check your input and try again.")}).always(function(){n.reset()})}function M(e){var t=p(e);p.post(e.action+"?"+p.param({redirect:"0"}),t.serialize(),function(){t.closest("li").slideUp(function(){var e=p(this).closest(".ui-sortable");p(this).remove(),p(document.body).trigger("sticky_kit:recalc"),e.length&&e.nestedSortable("refresh")})})}function Q(e,t){var r=p(e);p.post(e.action+"?"+p.param({redirect:t||"0",render:"listing",format:"partial"}),r.serialize(),function(e){var t=r.closest(".listing"),n=p("#listings"),n=p(".editing > ol.listings",n);t.length?(t.replaceWith(e),t.closest(".ui-sortable").nestedSortable("refresh")):(t=p(e),n.length?(t.hide().appendTo(n).fadeIn(),t.closest(".ui-sortable").nestedSortable("refresh")):(n=p("<ol>",{class:"listings"}).insertBefore(r.closest(".edit-tools")),t.appendTo(n),E(n)))})}var Z=function(e){var t=e.closest(".vcard"),n=p(".corrections-template"),r=p("form",n),i=o.getDisplayName()||"",a=o.getEmailAddress()||"";r[0]&&(r[0].reset(),i&&p('input[name="name"]',r).val(i),a&&p('input[name="email"]',r).val(a),p('input[name="source"]',r).val(p(".permalink",t).attr("href")),t.hasClass("office")?(p('input[name="kind"]',r).val("office"),p('input[name="id"]',r).val(t.data("listing-id"))):(p('input[name="kind"]',r).val("person"),p('input[name="id"]',r).val(t.data("uid"))),r.removeClass("dcf-d-none"),n.find(".success").addClass("dcf-d-none"),F(n,".correction-form",e))},$={queuePFRequest:function(e,t,n,r,i){var a={format:"partial"};n&&(a.chooser="true");var n=e,o=!1;r||i?(o=!0,n=r+" "+i,a.cn=r,a.sn=i):a.q=e,clearTimeout(c),d&&d.abort();var e=p.templates("#queryLengthTemplate"),s=p("#"+t);3<n.length?(Y.clear(),s.empty().append(b),c=setTimeout(function(){d=p.ajax({url:v,data:a,success:function(e,t){if("success"===t){var n,t=function(e,t){window.location.hash="q/"+e+"/"+t;var n=p.templates("#noticeTemplate"),t={originalSearch:y,firstName:e,lastName:t};p("#search-notice").html(n.render(t)),w++};if(0<=e.indexOf("Sorry, no results could be found.")&&y&&w<3){if(!o&&0<y.indexOf(" "))return void t((n=y.split(" ",2))[0],n[1].substring(0,1));if(o)return void(2===w?t((n=y.split(" ",2))[0].substring(0,1),n[1]):t((n=y.split(" ",2))[0],n[1].substring(0,1)))}s.html(e),p("ul.pfResult li",s).each(function(){p(".fn a",this).removeAttr("onclick")}),p("#search-notice").slideDown(400),w=1,Y.initialize(),W()}},error:function(e,t){"abort"!==t&&(t=p.templates(C),s.html(t.render()))}})},400)):n?s.html(e.render()):(s.empty(),S())},pfCatchUID:function(e){return console.log("I caught "+e+". You should create your own pfCatchUID function."),!1},initialize:function(s,e){$.initialize=p.noop,v=s,r=e;g=" | "+document.title.split(" | ").slice(-2).join(" | "),p(function(){var e,r,t,n,i,a,o;l.initializePlugin("notice"),p("#main-entry").remove(),p(T).appendTo("body"),p(window).on("hashchange",function(e){if(!(r=N())||P(r)){if(r){var t,n,r=r.split("/"),i=!1,a=p("#q"),r=3<=r.length?(i=!0,(n=decodeURIComponent(r[1]))+" "+(t=decodeURIComponent(r[2]))):decodeURIComponent(r[1]);return a.val(r),S(0),i?$.queuePFRequest("","results","",n,t):$.queuePFRequest(r,"results"),document.title="Search for "+r+g,!1}0===f&&S()}}),p(window).on("popstate",function(e){var n=e.originalEvent;if(n.state)n.state.uid?z("person",n.state.uid).then(function(e,t){"success"===t&&(e=p(e),_(n.state.uid,e),j(e.data("preferred-name"),e),S(1),D(e))},function(){S(0);var e=p.templates(C);m.empty().append(e.render())}):S();else if(2===u)A(),S(u);else{e=N();if(e&&P(e))return A(),void R(0);0===f&&R()}}),N()&&p(window).trigger("hashchange"),p(document).on("click","a.dir-btn-print-vcard",function(e){setTimeout(window.print,10),e.preventDefault()}),L=p("#modal_edit_form"),p(document).on("focusin",function(e){var t=L.get(0);L.hasClass("show")&&!p.contains(t,e.target)&&t!=e.target&&(e.stopPropagation(),L.focus())}),L.on("keydown",function(e){27===e.which&&G()}).on("submit","form.edit",function(e){var t,n=p(this).closest(".forms");e.preventDefault(),G(),n.data("department-id")?(t=p(e=this),p.post(e.action+"?"+p.param({redirect:"0",render:"summary",format:"partial"}),t.serialize(),function(e){t.closest(".department-summary").find(".departmentInfo").replaceWith(e),p(document.body).trigger("sticky_kit:recalc"),p(k).focus()})):n.data("listing-id")?Q(this):Q(this,"2")}).on("submit","form.delete",function(e){var t=p(this).closest(".forms");e.preventDefault(),G(),t.data("department-id")||M(this)}),p("#peoplefinder").length?O():p(".record-container .department-summary").length?(e=p(".record-container .department-summary"),r=p("#editBox"),t=p("#all_employees"),n=p("#listings"),i=p(".editing > ol.listings",n),a="Are you sure? This will permanently delete this record and any child records.",S(u=2),U(t),I(t),e.on("click",".vcard-tools .dir-btn-suggest-correction",function(e){return Z(p(e.target)),!1}).on("click",".vcard-tools .dir-btn-delete",function(e){if(!confirm(a))return!1}).on("click",".aliases .dir-btn-delete",function(){if(!confirm("Are you sure? This will delete the alias."))return!1}).on("submit",".aliases form.add",function(e){var t=p.templates("#deparmentAliasTemplate"),n=p('[name="name"]',this),n={url:this.action,name:n.val(),department:r.data("department-id")};e.preventDefault(),K(this,e.delegateTarget,"dept_aliases",t,n)}).on("submit",".aliases form.delete",function(e){e.preventDefault(),M(this)}).on("click",".users .dir-btn-delete",function(){if(!confirm("Are you sure? This will remove editing access for this user."))return!1}).on("submit",".users form.add",function(e){var t=p.templates("#departmentUserTemplate"),n=p('[name="uid"]',this),n={url:this.action,userUrl:s+"people/"+n.val(),uid:n.val(),department:r.data("department-id")};e.preventDefault(),K(this,e.delegateTarget,"dept_users",t,n)}).on("submit",".users form.delete",function(e){e.preventDefault(),M(this)}),i.length&&E(i),n.on("click",".listing-add",function(e){var t=this,n=p(this).closest(".edit-tools"),r=p(".form",n);return p(".edit",r).length?F(n,".forms",t):r.load(this.href+"?"+p.param({format:"partial"}),function(){F(n,".forms",t)}),!1}).on("submit","form.sortform",function(e){e.preventDefault(),p.post(this.action+"?"+p.param({redirect:0}),p(this).serialize())}),L.on("click.listings",".dir-btn-delete",function(e){if(!confirm(a))return!1}).on("click.listings",".listing-add",function(e){var t=p(this).closest(".forms");return p(".add-form",t).load(this.href+"?"+p.param({format:"partial"}),function(){t.addClass("show-add"),p("input:visible",this).first().focus()}),!1}),p(".department-correction").length&&(o=e.find(".vcard"),j(o.data("preferred-name"),o))):p(".record-container .vcard").length&&(S(u=1),o=p(".record-container .vcard"),_(o.data("uid"),o),j(o.data("preferred-name"),o),I(p(".record-container")),p(".record-container .directory-knowledge-summary").length),p("button.correction").click(function(e){Z(p(e.target))}),p(".corrections-template form").on("submit",function(e){e.preventDefault();e=p(this).closest(".correction-form");e.find("form").addClass("dcf-d-none");var t=e.find(".success");t.text("Submitting...").removeClass("dcf-d-none").focus(),p.post(this.action+"?"+p.param({format:"json"}),p(this).serialize()).done(function(){t.text("Thank you for your correction.").focus()}).fail(function(){t.text("There was an error submitting the correction, please try again later.").focus()})}),p("body").on("focusout",function(e){e=p(e.target);e.hasClass("programmatically-focused")&&e.removeClass("programmatically-focused")})})}};return $});
//# sourceMappingURL=directory.min.js.map