define(["jquery","wdn","require","idm","notice","./vendor/jsrender.js","./vendor/jquery.qtip.js"],function(l,c,e,a){"use strict";var d,u,t,f,m,p,h,g="https://directory.unl.edu/",r="https://annotate.unl.edu/",v="",y=l("<progress>",{class:"loading"}).text("Loading..."),w=1,b="#genericErrorTemplate",k="#dcf-main",_="#annotateTemplate",n=["searching","single","single-dept"],i=[],o=[],s=".results-container",C="empty-filters";const T=document.getElementById("filter_form"),L=document.getElementById("filter_reset"),E=document.getElementById("affiliation_filter"),q=document.getElementById("department_filter"),S=document.getElementById("skip_sidebar");let I,x,j,D,B,A,U;function z(e){void 0!==(p=e)&&(e=n[e]);var t=l(k);t.removeClass(n.join(" ")),e&&t.addClass(e)}function O(e){l(".record-single").empty().append(e)}function N(e,t){var n=l.templates(_),e=r+"?"+l.param({view:"annotation",sitekey:"directory",fieldname:e});l(n.render({annotateUrl:e,preferredName:t.data("preferred-name")})).appendTo(l(".vcard-tools.primary",t))}function P(e,t){var n=l.templates("#correctionButtonTemplate"),e=l(n.render({preferredName:e}));(t.hasClass("office")&&t.find(".department-correction").length?t.find(".department-correction"):t.find(".vcard-tools")).after(e)}function R(e,t){return t="org"===e?t+"/summary?format=partial":g+"hcards-full/"+t,l.ajax({url:t})}function F(){var e,t=l(".record-single .vcard");!t.length||(e=l(".ppl_Sresult.selected").filter(function(){return!l(".vcard",this).length&&l(this).data("uid")==t.data("uid")})).length&&e.append(t)}function M(e){e.on("click",".ppl_Sresult",function(e){var t=l(e.target),n=t.closest("a"),e=n.closest(".fn");if(!n.length||e.length){if(!t.closest(".correction").length)return $("person",l(this)),!1;le(t)}}),e.on("keydown",".ppl_Sresult",function(e){this===e.target&&13===e.which&&$("person",l(this))})}function W(e){e.on("click",".dir-btn-print-vcard",function(e){if(1!==p){var t=l(this).closest(".vcard");if(!t.length)return!1;var n=t.data("uid"),r=t.data("preferred-name");n=n,r=r,t=t,window.history.pushState&&window.history.pushState({uid:n},r,g+"people/"+n),z(1),O(t),window.print(),e.preventDefault()}else window.print()}),e.on("click",".directory_annotate",function(e){var t=l(this);e.preventDefault(),t.qtip({overwrite:!1,content:{text:l("<iframe>",{src:this.href,scrolling:"no",class:"directory_annotate_note",title:"Your notes"})},position:{my:"top right",at:"bottom right"},show:{event:e.type,ready:!0},hide:"unfocus"},e)})}function H(e){return e&&e.match(/^q\//)}function Y(){var e;t=l("#peoplefinder"),f=l("#results"),t.submit(function(e){l("#search-notice").slideUp(function(){l(this).empty()});var t,n=l("#q").val().trim();void 0!==I&&(x.innerText=n),n.length&&(t="#q/"+encodeURIComponent(n),window.location.hash=t,v=n),f.focus(),e.preventDefault()}),W(f.add(".record-container")),M(f),(e=f).on("click",".dep_result",function(e){var t=l(e.target),n=t.closest("a"),e=n.closest(".fn");if(!n.length||e.length){if(!t.closest(".correction").length)return $("org",l(this)),!1;le(t)}}),e.on("keydown",".dep_result",function(e){this===e.target&&13===e.which&&$("org",l(this))}),E.addEventListener("ready",()=>{E.classList.remove("dcf-d-none"),E.addEventListener("click",e=>{"INPUT"===e.target.tagName.toUpperCase()&&V.action()})}),q.addEventListener("ready",()=>{q.classList.remove("dcf-d-none"),q.addEventListener("click",e=>{"INPUT"===e.target.tagName.toUpperCase()&&V.action()})}),L.addEventListener("click",e=>{E.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.checked=!1}),q.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.checked=!1}),V.action()}),S.addEventListener("click",e=>{document.getElementById("results").focus()}),c.initializePlugin("collapsible-fieldsets")}function X(t){l(".help-container").length?z(t):l.ajax({url:g,data:{format:"partial"},success:function(e){z(t),l(k).empty().html(e),Y(),ee()&&l(window).trigger("hashchange")},error:function(){l(k).prepend("<p>Something went wrong. Please try again later.</p>")}})}function J(e,t,n){var r=l(te,K),i=l(t,e);Q?Q.detach():Q=l("<button>",{class:"cancel dcf-absolute dcf-pin-top dcf-pin-right dcf-mt-1 dcf-mr-1 dcf-btn dcf-btn-tertiary"}).click(function(){ie()}).html('<span aria-hidden="true">X</span>').append(l("<span>",{class:"dcf-sr-only"}).text("Close")),t=r.children(),Q.appendTo(r),ne&&t.length&&ne.append(t),ne=e,re=l(n),i.appendTo(r),l("html").css("overflow","hidden"),K.attr("aria-expanded","true"),K.addClass("show"),setTimeout(function(){r.focus()},400)}function G(i){c.initializePlugin("jqueryui",[function(){e(["./vendor/jquery.ui.touch-punch.js","./vendor/jquery.mjs.nestedSortable.js"],function(){var r=i.closest("#listings").find("form.sortform");i.nestedSortable({revert:!1,scroll:!0,delay:100,opacity:.45,tolerance:"pointer",helper:"clone",update:function(e,t){var n=JSON.stringify(i.nestedSortable("toHierarchy"));l('[name="sort_json"]',r).val(n),r.submit()},items:"li.listing",handle:".listingDetails",forcePlaceholderSize:!0,placeholder:"ui-placeholder",toleranceElement:".listingDetails"})})}]),i.on("click",".edit-button",function(e){var t=this,n=".forms",r=l(this).closest(".tools"),i=l(".form",r);return l(n,r).removeClass("show-add"),l(".edit",i).length?J(r,n,t):i.load(this.href+"?"+l.param({format:"partial"}),function(){J(r,n,t)}),!1})}var K,Q,V={initialize:function(){var e=l(".results",f),t=l(".ppl_Sresult",f);if(e.length&&t.length){T.classList.add("loading"),document.querySelector(s).classList.remove(C),l(".results",f).each(function(){l(this).hasClass("departments")||(l(".organization-unit",this).each(function(){var e=l(this).text().trim(),t=V.scrubDept(e.toLowerCase());l.inArray(e,i)<0&&i.push(e),l(this).parents(".ppl_Sresult").addClass(t)}),o.push(l(this).children("h2").eq(0).text()))}),i.sort(),o.sort(),V.buildFilterOptions(E,o),V.buildFilterOptions(q,i),T.classList.remove("loading"),i=[],o=[];const n=document.getElementById("summary_template");t=n.content.cloneNode("true");f.prepend(t),I=document.getElementById("search_summary"),x=document.getElementById("search_query"),j=document.getElementById("total_results"),D=document.getElementById("affiliation_filter_summary_container"),B=document.getElementById("affiliation_filter_summary"),A=document.getElementById("department_filter_summary_container"),U=document.getElementById("department_filter_summary"),x.innerText=decodeURI(ee().slice(2).replace("/"," ")),I.classList.remove("dcf-d-none")}else document.querySelector(s).classList.add(C)},clear:function(){T.classList.add("loading");const e=E.querySelector("ol"),t=q.querySelector("ol");if(null==e)throw new Error("Missing affiliation Filter OL");if(null==t)throw new Error("Missing department Filter OL");e.innerHTML="",t.innerHTML="",void 0!==I&&(I.classList.add("dcf-d-none"),D.classList.remove("dcf-d-block"),D.classList.add("dcf-d-none"),A.classList.remove("dcf-d-block"),A.classList.add("dcf-d-none"))},generateAllSummaryOption:function(){var e=l.templates("#summaryAllTemplate");return l(e.render())},buildFilterOptions:function(e,t){const a=e.id??"filter",s=e.querySelector("ol"),l=document.getElementById("filter_option_template");if(null==s)throw new Error("Missing Filter OL");if(null==l)throw new Error("Missing Option Template");t.forEach((e,t)=>{let n=l.content.cloneNode("true"),r=n.querySelector("input"),i=n.querySelector("label");if(null==r)throw new Error("Missing Option Input In Template");if(null==i)throw new Error("Missing Option Label In Template");var o=V.scrubDept(e.toLowerCase());r.id=a+"_"+t+"_"+o,r.value=o,r.dataset.value=e,i.setAttribute("for",r.id),i.innerText=e,s.append(n)})},action:function(){const e=T.querySelectorAll("input:checked"),a=document.querySelectorAll("div.results ul li"),t=document.querySelectorAll(".result_head, .likeResults, div.results.departments, div.results.affiliation");if(D.classList.add("dcf-d-none"),A.classList.add("dcf-d-none"),0===e.length)a.forEach(e=>{e.classList.remove("dcf-d-none")}),t.forEach(e=>{e.classList.remove("dcf-d-none")});else{a.forEach(e=>{e.classList.add("dcf-d-none")}),t.forEach(e=>{e.classList.add("dcf-d-none")});let i=[],o=[];if(e.forEach(e=>{var t=e.dataset.value;const n=e.value,r=e.id;a.forEach(e=>{e.classList.contains(n)&&(e.classList.remove("dcf-d-none"),e.closest(".results.affiliation")?.classList.remove("dcf-d-none"),e.closest(".likeResults")?.classList.remove("dcf-d-none"))}),r.startsWith("affiliation")&&i.push(t),r.startsWith("department")&&o.push(t)}),0<i.length){let e=i[0];2<i.length?(n=i.pop(),e=i.join(", ")+", or "+n):2==i.length&&(e=i.join(" or ")),B.innerText="Affiliations: "+e,D.classList.remove("dcf-d-none")}if(0<o.length){let e=o[0];var n;2<o.length?(n=o.pop(),e=o.join(", ")+", or "+n):2==o.length&&(e=o.join(" or ")),U.innerText="Departments: "+e,A.classList.remove("dcf-d-none")}}Z()},scrubDept:function(e){return e.split(" ").join("").replace(/&|,/gi,"")}},Z=function(){var e=l("div.results ul li:visible").length;e+=1===e?" total result":" total results",void 0!==j&&(j.innerText=e)},$=function(r,i,e){var o,t=".vcard";l(".error",i).remove();var a,n=i.children(t="org"===r?".departmentInfo":t),s=i.children(".overflow");return i.hasClass("selected")?(console.log("li selected"),void(e&&(n.hide(0,function(){s.show("fast",function(){l(this).addClass("dcf-d-flex")})}),i.removeClass("selected"),l("a:first",s).addClass("programmatically-focused").focus()))):(l("li.current",f).removeClass("current"),i.addClass("selected current"),n.length?(console.log("alreaded loaded"),s.hide(0,function(){l(this).removeClass("dcf-d-flex"),n.show("fast")}),void l("a:first",n).addClass("programmatically-focused").focus()):(i.children(".loading").length||(a=setTimeout(function(){i.append(y)},250)),o="org"===r?i.data("href"):i.data("uid"),void R(r,o).then(function(e,t){var n;"success"===t&&(n=l(e).hide(),i.append(n),n.parent().find("script").addClass("dcf-d-none"),(e=l("<button>",{class:"close-full-record dcf-btn dcf-btn-tertiary","aria-label":"close this record"})).click(function(){return console.log("close button clicked"),$(r,i,!0),!1}),e.text("X"),n.parent().find(".vcard:first").prepend(e),"org"!==r?(N(o,n),P(n.data("preferred-name"),n)):l(".department-correction",n).length&&P(n.data("preferred-name"),n.find(".vcard")),console.log("fetch record sliding"),s.hide(0,function(){l(this).removeClass("dcf-d-flex"),n.show("fast")}),l("a:first",n).addClass("programmatically-focused").focus(),clearTimeout(a),i.children(".loading").remove())},function(){var e=l.templates(b);i.append(e.render()),clearTimeout(a),i.children(".loading").remove()})))},ee=function(){return window.location.hash.replace("#","").trim()},te=".modal-content",ne=null,re=null,ie=function(){var e=l(te,K);K.hasClass("show")&&(Q&&Q.detach(),e=e.children(),ne&&(ne.append(e),ne=null),l("html").css("overflow",""),K.attr("aria-expanded","false"),K.removeClass("show"),re&&(re.focus(),re=null))};l(".edit-button").removeClass("dcf-d-none");function oe(n,r,i,o,a){l.post(n.action+"?"+l.param({redirect:"0"}),l(n).serialize(),function(){var e=l(o.render(a)).hide(),t=l("."+i,r);(t=!t.length?l("<ul>",{class:i}).insertBefore(n):t).append(e),e.fadeIn(function(){l(document.body).trigger("sticky_kit:recalc")}),n.reset()}).fail(function(){alert("Your request failed. Please check your input and try again.")}).always(function(){n.reset()})}function ae(e){var t=l(e);l.post(e.action+"?"+l.param({redirect:"0"}),t.serialize(),function(){t.closest("li").slideUp(function(){var e=l(this).closest(".ui-sortable");l(this).remove(),l(document.body).trigger("sticky_kit:recalc"),e.length&&e.nestedSortable("refresh")})})}function se(e,t){var r=l(e);l.post(e.action+"?"+l.param({redirect:t||"0",render:"listing",format:"partial"}),r.serialize(),function(e){var t=r.closest(".listing"),n=l("#listings"),n=l(".editing > ol.listings",n);t.length?(t.replaceWith(e),t.closest(".ui-sortable").nestedSortable("refresh")):(t=l(e),n.length?(t.hide().appendTo(n).fadeIn(),t.closest(".ui-sortable").nestedSortable("refresh")):(n=l("<ol>",{class:"listings"}).insertBefore(r.closest(".edit-tools")),t.appendTo(n),G(n)))})}var le=function(e){var t=e.closest(".vcard"),n=l(".corrections-template"),r=l("form",n),i=a.getDisplayName()||"",o=a.getEmailAddress()||"";r[0]&&(r[0].reset(),i&&l('input[name="name"]',r).val(i),o&&l('input[name="email"]',r).val(o),l('input[name="source"]',r).val(l(".permalink",t).attr("href")),t.hasClass("office")?(l('input[name="kind"]',r).val("office"),l('input[name="id"]',r).val(t.data("listing-id"))):(l('input[name="kind"]',r).val("person"),l('input[name="id"]',r).val(t.data("uid"))),r.removeClass("dcf-d-none"),n.find(".success").addClass("dcf-d-none"),J(n,".correction-form",e))},ce={queuePFRequest:function(e,t,n,r,i){var o={format:"partial"};n&&(o.chooser="true");var n=e,a=!1;r||i?(a=!0,n=r+" "+i,o.cn=r,o.sn=i):o.q=e,clearTimeout(d),u&&u.abort();var e=l.templates("#queryLengthTemplate"),s=l("#"+t);3<n.length?(V.clear(),s.empty().append(y),d=setTimeout(function(){u=l.ajax({url:g,data:o,success:function(e,t){if("success"===t){var n,t=function(e,t){window.location.hash="q/"+e+"/"+t,void 0!==x&&(x.innerText=e+" "+t);var n=l.templates({markup:"#noticeTemplate",allowCode:!0}),t={originalSearch:v,firstName:e,lastName:t};l("#search-notice").html(n.render(t)),w++};if(0<=e.indexOf("Sorry, no results could be found.")&&v&&w<3){if(!a&&0<v.indexOf(" "))return void t((n=v.split(" ",2))[0],n[1].substring(0,1));if(a)return void(2===w?t((n=v.split(" ",2))[0].substring(0,1),n[1]):t((n=v.split(" ",2))[0],n[1].substring(0,1)))}s.html(e),l("ul.pfResult li",s).each(function(){l(".fn a",this).removeAttr("onclick")}),l("#search-notice").slideDown(400),w=1,V.initialize(),Z()}},error:function(e,t){"abort"!==t&&(t=l.templates(b),s.html(t.render()))}})},400)):n?s.html(e.render()):(s.empty(),z())},pfCatchUID:function(e){return console.log("I caught "+e+". You should create your own pfCatchUID function."),!1},initialize:function(s,e){ce.initialize=l.noop,g=s,r=e;h=" | "+document.title.split(" | ").slice(-2).join(" | "),l(function(){var e,r,t,n,i,o,a;c.initializePlugin("notice"),l("#main-entry").remove(),l(_).appendTo("body"),l(window).on("hashchange",function(e){if(!(r=ee())||H(r)){if(r){var t,n,r=r.split("/"),i=!1,o=l("#q"),r=3<=r.length?(i=!0,(n=decodeURIComponent(r[1]))+" "+(t=decodeURIComponent(r[2]))):decodeURIComponent(r[1]);return o.val(r),z(0),i?ce.queuePFRequest("","results","",n,t):ce.queuePFRequest(r,"results"),document.title="Search for "+r+h,!1}0===p&&z()}}),l(window).on("popstate",function(e){var n=e.originalEvent;if(n.state)n.state.uid?R("person",n.state.uid).then(function(e,t){"success"===t&&(e=l(e),N(n.state.uid,e),P(e.data("preferred-name"),e),z(1),O(e))},function(){z(0);var e=l.templates(b);f.empty().append(e.render())}):z();else if(2===m)F(),z(m);else{e=ee();if(e&&H(e))return F(),void X(0);0===p&&X()}}),ee()&&l(window).trigger("hashchange"),l(document).on("click","a.dir-btn-print-vcard",function(e){setTimeout(window.print,10),e.preventDefault()}),K=l("#modal_edit_form"),l(document).on("focusin",function(e){var t=K.get(0);K.hasClass("show")&&!l.contains(t,e.target)&&t!=e.target&&(e.stopPropagation(),K.focus())}),K.on("keydown",function(e){27===e.which&&ie()}).on("submit","form.edit",function(e){var t,n=l(this).closest(".forms");e.preventDefault(),ie(),n.data("department-id")?(t=l(e=this),l.post(e.action+"?"+l.param({redirect:"0",render:"summary",format:"partial"}),t.serialize(),function(e){t.closest(".department-summary").find(".departmentInfo").replaceWith(e),l(document.body).trigger("sticky_kit:recalc"),l(k).focus()})):n.data("listing-id")?se(this):se(this,"2")}).on("submit","form.delete",function(e){var t=l(this).closest(".forms");e.preventDefault(),ie(),t.data("department-id")||ae(this)}),l("#peoplefinder").length?Y():l(".record-container .department-summary").length?(e=l(".record-container .department-summary"),r=l("#editBox"),t=l("#all_employees"),n=l("#listings"),i=l(".editing > ol.listings",n),o="Are you sure? This will permanently delete this record and any child records.",z(m=2),M(t),W(t),e.on("click",".vcard-tools .dir-btn-suggest-correction",function(e){return le(l(e.target)),!1}).on("click",".vcard-tools .dir-btn-delete",function(e){if(!confirm(o))return!1}).on("click",".aliases .dir-btn-delete",function(){if(!confirm("Are you sure? This will delete the alias."))return!1}).on("submit",".aliases form.add",function(e){var t=l.templates("#deparmentAliasTemplate"),n=l('[name="name"]',this),n={url:this.action,name:n.val(),department:r.data("department-id")};e.preventDefault(),oe(this,e.delegateTarget,"dept_aliases",t,n)}).on("submit",".aliases form.delete",function(e){e.preventDefault(),ae(this)}).on("click",".users .dir-btn-delete",function(){if(!confirm("Are you sure? This will remove editing access for this user."))return!1}).on("submit",".users form.add",function(e){var t=l.templates("#departmentUserTemplate"),n=l('[name="uid"]',this),n={url:this.action,userUrl:s+"people/"+n.val(),uid:n.val(),department:r.data("department-id")};e.preventDefault(),oe(this,e.delegateTarget,"dept_users",t,n)}).on("submit",".users form.delete",function(e){e.preventDefault(),ae(this)}),i.length&&G(i),n.on("click",".listing-add",function(e){var t=this,n=l(this).closest(".edit-tools"),r=l(".form",n);return l(".edit",r).length?J(n,".forms",t):r.load(this.href+"?"+l.param({format:"partial"}),function(){J(n,".forms",t)}),!1}).on("submit","form.sortform",function(e){e.preventDefault(),l.post(this.action+"?"+l.param({redirect:0}),l(this).serialize())}),K.on("click.listings",".dir-btn-delete",function(e){if(!confirm(o))return!1}).on("click.listings",".listing-add",function(e){var t=l(this).closest(".forms");return l(".add-form",t).load(this.href+"?"+l.param({format:"partial"}),function(){t.addClass("show-add"),l("input:visible",this).first().focus()}),!1}),l(".department-correction").length&&(a=e.find(".vcard"),P(a.data("preferred-name"),a))):l(".record-container .vcard").length&&(z(m=1),a=l(".record-container .vcard"),N(a.data("uid"),a),P(a.data("preferred-name"),a),W(l(".record-container")),l(".record-container .directory-knowledge-summary").length),l("button.correction").click(function(e){le(l(e.target))}),l(".corrections-template form").on("submit",function(e){e.preventDefault();e=l(this).closest(".correction-form");e.find("form").addClass("dcf-d-none");var t=e.find(".success");t.text("Submitting...").removeClass("dcf-d-none").focus(),l.post(this.action+"?"+l.param({format:"json"}),l(this).serialize()).done(function(){t.text("Thank you for your correction.").focus()}).fail(function(){t.text("There was an error submitting the correction, please try again later.").focus()})}),l("body").on("focusout",function(e){e=l(e.target);e.hasClass("programmatically-focused")&&e.removeClass("programmatically-focused")})})}};return ce});
//# sourceMappingURL=directory.min.js.map